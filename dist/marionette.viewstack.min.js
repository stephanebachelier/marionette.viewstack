/*! marionette.viewstack - v0.5.3
 *  Release on: 2015-02-02
 *  Copyright (c) 2015 StÃ©phane Bachelier
 *  Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["marionette","hashmapper"],b):"object"==typeof exports?module.exports=b(require("marionette"),require("hashmapper")):b(Marionette,hashmapper)}(this,function(a,b){"use strict";a.viewStack={};var c=function(a){this.options=a||{},this._ensureElement(),this.stucked=[]};c.prototype={_ensureElement:function(){this.el=document.querySelector(this.options.el),this.$el=Backbone.$(this.el)},regionEl:function(){return document.createElement("div")},buildRegion:function(b){var c=b.regionClass||this.regionClass||a.Region,d=b.el||this.regionEl();return new c({el:d})},injectElement:function(a,b){var c=b&&b.sticky;if(this.el.contains(a.el)){var d=this.stucked.length;if(d){for(var e,f=0;!e&&d-1>f;f+=1)e=this.stucked[f].parentNode?this.stucked[f]:void 0;this.el.insertBefore(a.el,e)}else this.el.appendChild(a.el)}else this.el.appendChild(a.el);c&&-1===this.stucked.indexOf(a.el)&&this.stucked.push(a.el)},show:function(a,b){return this.showIn(null,a,b)},showIn:function(a,b,c){return a=a||this.buildRegion(c),this.injectElement(a,c),this.triggerMethod("before:view:show",a,b,c),a.show(b,c),this.triggerMethod("view:show",a,b,c),a},remove:function(a,b){if(!a)throw new Error("no region found for given view.");if(a.currentView){var c=this.triggerMethod("before:view:remove",a,a.currentView);if(!1!==c){var d=b&&b.destroy;(void 0===d||null===d)&&(d=!0),a.empty();var e=this.stucked.indexOf(a.el);-1!==e&&(this.stucked=this.stucked.splice(e,1)),d&&(a.destroy(),a.$el.remove(),a.reset(),a=null)}}},removeViews:function(a){for(var b=0,c=a.length;c>b;b+=1)this.remove(a[b]);a=null},swap:function(a,b){return this.el.contains(a.el)?void this.injectElement(a,b):!1},triggerMethod:a.triggerMethod},c.extend=a.extend,a.viewStack.ViewController=c;var d=function(a){this.options=a||{},this.viewController=this.options.controller||this.getDefaultViewController(a),this.container=this.options.container||this.getDefaultContainer()};d.prototype={getDefaultViewController:function(a){return new c({el:a.el})},getDefaultContainer:function(){return new b},push:function(a,b){return this.pushIn(null,a,b)},pushIn:function(a,b,c){return b.once("destroy",function(){this.container.remove(b.cid)},this),this.container.add(b.cid,this.viewController.showIn(a,b,c)),b},pop:function(a){var b=a?this.container.get(a.cid):this.container.last();return this.viewController.remove(b)},popAll:function(a,b){a||this.pop(),b=b||{};var c=this.container.invertedRange(a.cid,this.container.last(),b);return this.viewController.removeViews(c)},popUntil:function(a){return a?this.popAll(a,{excludeStart:!0}):void 0},swap:function(a,b){var c=this.container.get(a.cid);return this.viewController.swap(c,b)},length:function(){return this.container.length()},isEmpty:function(){return 0<=this.length()},contains:function(a){return void 0!==this.container.get(a.cid)}},d.extend=a.extend,d=d.extend(Backbone.Events),a.viewStack.ViewStack=d;var e=Object.create(null);e={create:function(){}},e.extend=a.extend,a.viewStack.ViewFactory=e;var f=function(a){this.options=a||{},this._hashmap=this.options.hashmap||this.getDefaultContainer()};f.prototype={getDefaultContainer:function(){return new b},push:function(a,b,c){if(c&&!0===c.smart){var d=_.partial(this.remove,a);b.once("destroy",_.bind(d,this),this)}this._hashmap.add(a,b)},get:function(a){return this._hashmap.get(a)},remove:function(a){return this._hashmap.remove(a)}},f.extend=a.extend,a.viewStack.ViewCache=f;var g=function(a,b){this._views=a,this.options=b||{},this._stack=this.options.viewStack||this.getViewStack(),this._cache=this.options.cache||this.getViewCache()};g.prototype={getViewFactory:function(a){var b=this._views[a];if(!b)throw new Error("Cannot find ["+a+"] view factory.");return b},getViewStack:function(){},getViewCache:function(){return new f},getCacheUid:function(a){return a},getView:function(a,b,c){var d,e=(a.getCacheUid||this.getCacheUid)(b,c);return e&&(d=this._cache.get(e)),d?d:(d=a.create(c),e&&this._cache.push(e,d,{smart:!0}),d)},pop:function(a){this._stack.pop(a)},popUntil:function(a){var b=this._cache.get(a);b&&this._stack.popUntil(b)},push:function(a,b,c){var d=this.getViewFactory(a),e=this.getView(d,a,b);this._stack.contains(e)&&this._stack.swap(e,c||{});var f;d.getViewStackOptions&&_.isFunction(d.getViewStackOptions)?f={ctx:d,func:d.getViewStackOptions}:this.getViewStackOptions&&_.isFunction(this.getViewStackOptions)&&(f={ctx:this,func:this.getViewStackOptions});var g,h=f?f.func.call(f.ctx,a,e,c):c;d.getViewWrapper&&_.isFunction(d.getViewWrapper)?g={ctx:d,func:d.getViewWrapper}:this.getViewWrapper&&_.isFunction(this.getViewWrapper)&&(g={ctx:this,func:this.getViewWrapper});var i=g?g.func.call(g.ctx,e,b,h):void 0;return this._stack.pushIn(i,e,h||{}),e},render:function(a,b){var c=this.getViewFactory(a),d=this.getView(c,a,b);return d.render(),d},renderIn:function(a,b,c){var d=this.getViewFactory(b),e=this.getView(d,b,c);return e&&a.show(e),e}},g.extend=a.extend,a.viewStack.ViewStackFactory=g;var h=g.extend({getViewFactory:function(a){var b=this._viewClasses?this._viewClasses[a]:null;if(!b)throw new Error("Cannot find ["+a+"] view factory.");return b},syncPush:g.prototype.push,push:function(a,b,c){var d=this;return this.load(a).then(function(){return d.syncPush(a,b,c)})},renderSync:g.prototype.render,render:function(a,b){var c=this;return this.load(a).then(function(){return c.renderSync(a,b)})},renderInSync:g.prototype.renderIn,renderIn:function(a,b,c){var d=this;return this.load(b).then(function(){return d.renderInSync(a,b,c)})},load:function(a){var b=this;return new Promise(function(c,d){return b._views[a]?b._viewClasses&&b._viewClasses[a]?void c(b._viewClasses[a]):void b._load(b._views[a],function(e){return e?(b._viewClasses||(b._viewClasses={}),b._viewClasses[a]=e,void c(e)):void d("No view implementation found with the name ["+a+"]")}):void d("No view registered with the name ["+a+"]")})},_load:function(a,b){require([a],b)}});return h.extend=a.extend,a.viewStack.ViewStackAmdFactory=h,a.viewStack});