/*! marionette.viewstack - v0.2.1
 *  Release on: 2015-01-15
 *  Copyright (c) 2015 StÃ©phane Bachelier
 *  Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["marionette","hashmapper"],b):"object"==typeof exports?module.exports=b(require("marionette"),require("hashmapper")):b(Marionette,hashmapper)}(this,function(a,b){"use strict";a.viewStack={};var c=function(a){this.options=a||{},this._ensureElement()};c.prototype={_ensureElement:function(){this.el=document.querySelector(this.options.el),this.$el=Backbone.$(this.el)},regionEl:function(){return document.createElement("div")},buildRegion:function(b){var c=b.regionClass||this.regionClass||a.Region,d=b.el||this.regionEl();return new c({el:d})},show:function(a,b){return this.showIn(null,a,b)},showIn:function(a,b,c){return a=a||this.buildRegion(c),this.el.contains(a.el)||this.el.appendChild(a.el),this.triggerMethod("before:view:show",a,b,c),a.show(b,c),this.triggerMethod("view:show",a,b,c),a},remove:function(a,b){if(!a)throw new Error("no region found for given view.");if(a.currentView){var c=a.currentView.cid,d=this.triggerMethod("before:view:remove",a,a.currentView);if(!1!==d){this.triggerMethod("view:remove",a,a.currentView);var e=b&&b.destroy;(void 0===e||null===e)&&(e=!0),a.empty(),e&&(a.$el.remove(),a.destroy(),this.triggerMethod("view:removed",c))}}},removeViews:function(a){for(var b=0,c=a.length;c>b;b+=1)this.remove(a[b]);a=null},swap:function(a){return this.el.contains(a.el)?void this.$el.children().last().after(a.$el.parent()):!1},triggerMethod:a.triggerMethod},c.extend=a.extend,a.viewStack.ViewController=c;var d=function(a){this.options=a||{},this.viewController=this.options.controller||this.getDefaultViewController(a),this.container=this.options.container||this.getDefaultContainer()};d.prototype={getDefaultViewController:function(a){return new c({el:a.el})},getDefaultContainer:function(){return new b},push:function(a,b){return this.pushIn(null,a,b)},pushIn:function(a,b,c){return this.container.add(b.cid,this.viewController.showIn(a,b,c)),b},pop:function(a){var b=a?this.container.get(a.cid):this.container.last();return this.viewController.remove(b)},popAll:function(a,b){a||this.pop(),b=b||{};var c=this.container.invertedRange(a.cid,this.container.last(),b);return this.viewController.removeViews(c)},popUntil:function(a){return a?this.popAll(a,{excludeStart:!0}):void 0},swap:function(a,b){return this.viewController.swap(a,b)}},d.extend=a.extend,d=d.extend(Backbone.Events),a.viewStack.ViewStack=d;var e=Object.create(null);e={create:function(){}},e.extend=a.extend,a.viewStack.ViewFactory=e;var f=function(a){this.options=a||{},this._hashmap=this.options.hashmap||this.getDefaultContainer()};f.prototype={getDefaultContainer:function(){return new b},push:function(a,b,c){if(c&&!0===c.smart){var d=_.partial(this.remove,a);b.once("destroy",_.bind(d,this),this)}this._hashmap.add(a,b)},get:function(a){return this._hashmap.get(a)},remove:function(a){return this._hashmap.remove(a)}},f.extend=a.extend,a.viewStack.ViewCache=f;var g=function(a,b){this._views=a,this.options=b||{},this._stack=this.options.viewStack||this.getViewStack(),this._cache=this.options.cache||this.getViewCache()};return g.prototype={getViewFactory:function(a){var b=this._views[a];if(!b)throw new Error("Cannot find ["+a+"] view factory.");return b},getViewStack:function(){},getViewCache:function(){return new f},getCacheUid:function(a){return a},pop:function(a){this._stack.pop(a)},popUntil:function(a){var b=this._cache.get(a);b&&this._stack.popUntil(b)},push:function(a,b,c){var d=this.getViewFactory(a),e=(d.getCacheUid||this.getCacheUid)(a,b),f=this._cache.get(e);if(f)return this._stack.swap(f,c||{}),f;f=d.create(b),this._cache.push(e,f,{smart:!0});var g=d.getViewStackOptions||this.getViewStackOptions,h=_.isFunction(g)?g(a,f,c):c,i=d.getViewWrapper||this.getViewWrapper,j=_.isFunction(i)?i(f,b,h):void 0;return this._stack.pushIn(j,f,h||{}),f}},g.extend=a.extend,a.viewStack.ViewStackFactory=g,a.viewStack});