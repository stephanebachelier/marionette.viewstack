/*! marionette.viewstack - v0.4.5
 *  Release on: 2015-01-27
 *  Copyright (c) 2015 StÃ©phane Bachelier
 *  Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["marionette","hashmapper"],b):"object"==typeof exports?module.exports=b(require("marionette"),require("hashmapper")):b(Marionette,hashmapper)}(this,function(a,b){"use strict";a.viewStack={};var c=function(a){this.options=a||{},this._ensureElement(),this.stucked=[]};c.prototype={_ensureElement:function(){this.el=document.querySelector(this.options.el),this.$el=Backbone.$(this.el)},regionEl:function(){return document.createElement("div")},buildRegion:function(b){var c=b.regionClass||this.regionClass||a.Region,d=b.el||this.regionEl();return new c({el:d})},injectElement:function(a,b){var c=b&&b.sticky;if(this.el.contains(a.el)){var d=this.stucked.length;if(d){for(var e,f=0;!e&&d-1>f;f+=1)e=this.stucked[f].parentNode?this.stucked[f]:void 0;this.el.insertBefore(a.el,e)}else this.el.appendChild(a.el)}else this.el.appendChild(a.el);c&&this.stucked.push(a.el)},show:function(a,b){return this.showIn(null,a,b)},showIn:function(a,b,c){return a=a||this.buildRegion(c),this.injectElement(a,c),this.triggerMethod("before:view:show",a,b,c),a.show(b,c),this.triggerMethod("view:show",a,b,c),a},remove:function(a,b){if(!a)throw new Error("no region found for given view.");if(a.currentView){var c=a.currentView.cid,d=this.triggerMethod("before:view:remove",a,a.currentView);if(!1!==d){this.triggerMethod("view:remove",a,a.currentView);var e=b&&b.destroy;(void 0===e||null===e)&&(e=!0),a.empty();var f=this.stucked.indexOf(a.el);-1!==f&&(this.stucked=this.stucked.splice(f,1)),e&&(a.$el.remove(),a.destroy(),this.triggerMethod("view:removed",c))}}},removeViews:function(a){for(var b=0,c=a.length;c>b;b+=1)this.remove(a[b]);a=null},swap:function(a,b){return this.el.contains(a.el)?void this.injectElement(a,b):!1},triggerMethod:a.triggerMethod},c.extend=a.extend,a.viewStack.ViewController=c;var d=function(a){this.options=a||{},this.viewController=this.options.controller||this.getDefaultViewController(a),this.container=this.options.container||this.getDefaultContainer()};d.prototype={getDefaultViewController:function(a){return new c({el:a.el})},getDefaultContainer:function(){return new b},push:function(a,b){return this.pushIn(null,a,b)},pushIn:function(a,b,c){return b.once("destroy",function(){this.container.remove(b.cid)},this),this.container.add(b.cid,this.viewController.showIn(a,b,c)),b},pop:function(a){var b=a?this.container.get(a.cid):this.container.last();return this.viewController.remove(b)},popAll:function(a,b){a||this.pop(),b=b||{};var c=this.container.invertedRange(a.cid,this.container.last(),b);return this.viewController.removeViews(c)},popUntil:function(a){return a?this.popAll(a,{excludeStart:!0}):void 0},swap:function(a,b){var c=this.container.get(a.cid);return this.viewController.swap(c,b)},length:function(){return this.container.length()},isEmpty:function(){return 0<=this.length()}},d.extend=a.extend,d=d.extend(Backbone.Events),a.viewStack.ViewStack=d;var e=Object.create(null);e={create:function(){}},e.extend=a.extend,a.viewStack.ViewFactory=e;var f=function(a){this.options=a||{},this._hashmap=this.options.hashmap||this.getDefaultContainer()};f.prototype={getDefaultContainer:function(){return new b},push:function(a,b,c){if(c&&!0===c.smart){var d=_.partial(this.remove,a);b.once("destroy",_.bind(d,this),this)}this._hashmap.add(a,b)},get:function(a){return this._hashmap.get(a)},remove:function(a){return this._hashmap.remove(a)}},f.extend=a.extend,a.viewStack.ViewCache=f;var g=function(a,b){this._views=a,this.options=b||{},this._stack=this.options.viewStack||this.getViewStack(),this._cache=this.options.cache||this.getViewCache()};g.prototype={getViewFactory:function(a){var b=this._views[a];if(!b)throw new Error("Cannot find ["+a+"] view factory.");return b},getViewStack:function(){},getViewCache:function(){return new f},getCacheUid:function(a){return a},pop:function(a){this._stack.pop(a)},popUntil:function(a){var b=this._cache.get(a);b&&this._stack.popUntil(b)},push:function(a,b,c){var d=this.getViewFactory(a),e=(d.getCacheUid||this.getCacheUid)(a,b),f=this._cache.get(e);if(f)return this._stack.swap(f,c||{}),f;f=d.create(b),this._cache.push(e,f,{smart:!0});var g;d.getViewStackOptions&&_.isFunction(d.getViewStackOptions)?g={ctx:d,func:d.getViewStackOptions}:this.getViewStackOptions&&_.isFunction(this.getViewStackOptions)&&(g={ctx:this,func:this.getViewStackOptions});var h,i=g?g.func.call(g.ctx,a,f,c):c;d.getViewWrapper&&_.isFunction(d.getViewWrapper)?h={ctx:d,func:d.getViewWrapper}:this.getViewWrapper&&_.isFunction(this.getViewWrapper)&&(h={ctx:this,func:this.getViewWrapper});var j=h?h.func.call(h.ctx,f,b,i):void 0;return this._stack.pushIn(j,f,i||{}),f}},g.extend=a.extend,a.viewStack.ViewStackFactory=g;var h=g.extend({getViewFactory:function(a){var b=this._viewClasses?this._viewClasses[a]:null;if(!b)throw new Error("Cannot find ["+a+"] view factory.");return b},syncPush:g.prototype.push,push:function(a,b,c){var d=this,e=new Promise(function(e,f){return d._views[a]?d._viewClasses&&d._viewClasses[a]?void e(d.syncPush(a,b,c)):void d.load(d._views[a],function(g){return g?(d._viewClasses||(d._viewClasses={}),d._viewClasses[a]=g,void e(d.syncPush(a,b,c))):void f("No view implementation found with the name ["+a+"]")}):void f("No view registered with the name ["+a+"]")});return e},load:function(a,b){require([a],b)}});return h.extend=a.extend,a.viewStack.ViewStackAmdFactory=h,a.viewStack});